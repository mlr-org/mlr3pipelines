<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google Site Verification --><meta name="google-site-verification" content="BrjL5fpoyHZu1rR8rwnnM2MBO3u3iIFB8NsmSuOsY84">
<title>Custom PipeOps • mlr3pipelines</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Custom PipeOps">
<meta property="og:description" content="">
<meta property="og:image" content="https://mlr3pipelines.mlr-org.com/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="icon" type="image/png" href="https://mlr-org.github.io/mlr/favicon.ico">
<link rel="apple-touch-icon" type="image/png" href="https://mlr-org.github.io/mlr/favicon.ico">
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html"></a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Basics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/a_simple_pipeline.html">A simple pipeline</a>
    </li>
    <li>
      <a href="../articles/basic_concepts.html">Showcase: Basic Concepts: PipeOp and Graph</a>
    </li>
    <li>
      <a href="../articles/branching.html">Showcase: Branching</a>
    </li>
    <li>
      <a href="../articles/stacking_and_bagging.html">Showcase: Bagging and Stacking</a>
    </li>
    <li>
      <a href="../articles/create_a_custom_pipeop.html">Custom PipeOps</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Appendix
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Function Reference</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlr-org/mlr3pipelines">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://mlr-org.slack.com">
    <span class="fa fa-slack"></span>
     
  </a>
</li>
<li>
  <a href="https://stackoverflow.com/questions/tagged/mlr">
    <span class="fa fa-stack-overflow"></span>
     
  </a>
</li>
<li>
  <a href="https://mlr-org.com/">
    <span class="fa fa-rss"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Custom PipeOps</h1>
                        <h4 class="author">Martin Binder</h4>
            
      
      <!--The 'toc' block was inserted manually by @pat-s. It triggeres the inline ToC in the vignettes.-->
            <div id="toc">
      <h3 class="hasAnchor">
<a href="#toc" class="anchor"></a>Table of Contents</h3>
      <ul>
<li><a href="#how-things-work-around-here">How Things Work Around Here</a></li>
      <li>
<a href="#general-case-example-pipeopcopy">General Case Example: <code>PipeOpCopy</code></a><ul>
<li><a href="#first-steps-inheriting-from-pipeop">First Steps: Inheriting from <code>PipeOp</code></a></li>
      <li><a href="#channel-definitions">Channel Definitions</a></li>
      <li><a href="#train-and-predict">Train and Predict</a></li>
      <li><a href="#putting-it-together">Putting it Together</a></li>
      </ul>
</li>
      <li>
<a href="#special-case-preprocessing">Special Case: Preprocessing</a><ul>
<li><a href="#example-pipeopdropna">Example: <code>PipeOpDropNA</code></a></li>
      <li><a href="#example-pipeopscalealways">Example: <code>PipeOpScaleAlways</code></a></li>
      </ul>
</li>
      <li>
<a href="#special-case-preprocessing-with-simple-train">Special Case: Preprocessing with Simple Train</a><ul>
<li><a href="#example-pipeopdropconst">Example: <code>PipeOpDropConst</code></a></li>
      <li><a href="#example-pipeopscalealwayssimple">Example: <code>PipeOpScaleAlwaysSimple</code></a></li>
      </ul>
</li>
      <li>
<a href="#hyperparameters">Hyperparameters</a><ul>
<li><a href="#hyperparameter-example-pipeopscale">Hyperparameter Example: <code>PipeOpScale</code></a></li>
      </ul>
</li>
      </ul>
</div>
      
      <small>Source: <a href="https://github.com/mlr-org/mlr3pipelines/blob/master/vignettes/create_a_custom_pipeop.Rmd"><code>vignettes/create_a_custom_pipeop.Rmd</code></a></small>

    </div>

    
    
<div class="contents">
<p>This vignette shows how the <code>mlr3pipelines</code> package can be extended to include custom <code>PipeOps</code>. To run the following examples, we will need a <code>Task</code>; we are using the well-known “Iris” task:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mlr3)</a>
<a class="sourceLine" id="cb1-2" title="2">task =<span class="st"> </span>mlr_tasks<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(<span class="st">"iris"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4">task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#&gt;        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#&gt;   1:    setosa          1.4         0.2          5.1         3.5</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#&gt;   2:    setosa          1.4         0.2          4.9         3.0</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&gt;   3:    setosa          1.3         0.2          4.7         3.2</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&gt;   4:    setosa          1.5         0.2          4.6         3.1</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#&gt;   5:    setosa          1.4         0.2          5.0         3.6</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#&gt;  ---                                                            </span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co">#&gt; 146: virginica          5.2         2.3          6.7         3.0</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co">#&gt; 147: virginica          5.0         1.9          6.3         2.5</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#&gt; 148: virginica          5.2         2.0          6.5         3.0</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#&gt; 149: virginica          5.4         2.3          6.2         3.4</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">#&gt; 150: virginica          5.1         1.8          5.9         3.0</span></a></code></pre></div>
<div id="how-things-work-around-here" class="section level2">
<h2 class="hasAnchor">
<a href="#how-things-work-around-here" class="anchor"></a>How Things Work Around Here</h2>
<p><code>mlr3pipelines</code> is fundamentally built around <a href="https://r6.r-lib.org/"><code>R6</code></a>. When planning to create custom <code>PipeOp</code> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html">familiarize yourself with it</a>.</p>
<p>In principle, all a <code>PipeOp</code> must do is inherit from the <code>PipeOp</code> R6 class and implement the <code>train()</code> and <code>test()</code> functions. There are, however, several auxiliary subclasses that can make the creation of <em>certain</em> operations much easier.</p>
</div>
<div id="general-case-example-pipeopcopy" class="section level2">
<h2 class="hasAnchor">
<a href="#general-case-example-pipeopcopy" class="anchor"></a>General Case Example: <code>PipeOpCopy</code>
</h2>
<p>A very simple yet useful <code>PipeOp</code> is <code>PipeOpCopy</code>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data. It is a simple example that showcases the important steps in defining a custom <code>PipeOp</code>. We will show a simplified version here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly two copies of its input data.</p>
<p>The following figure visualizes how our <code>PipeOp</code> is situated in the <code>Pipeline</code> and the significant in- and outputs.</p>
<div class="figure">
<img src="figures/po_multi_viz.png" alt="Pipeop Copy2" style="width:90.0%"><p class="caption">Pipeop Copy2</p>
</div>
<div id="first-steps-inheriting-from-pipeop" class="section level3">
<h3 class="hasAnchor">
<a href="#first-steps-inheriting-from-pipeop" class="anchor"></a>First Steps: Inheriting from <code>PipeOp</code>
</h3>
<p>The first part of creating a custom <code>PipeOp</code> is inheriting from <code>PipeOp</code>. We make a mental note that we need to implement a <code>train()</code> and a <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict()</a></code> function, and that we probably want to have an <code>initialize()</code> as well:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">PipeOpCopyTwo =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpCopyTwo"</span>,</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">inherit =</span> PipeOp,</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"copy.two"</span>) {</a>
<a class="sourceLine" id="cb2-5" title="5">      ....</a>
<a class="sourceLine" id="cb2-6" title="6">    },</a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="dt">train =</span> <span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb2-9" title="9">      ....</a>
<a class="sourceLine" id="cb2-10" title="10">    },</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="dt">predict =</span> <span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb2-13" title="13">      ....</a>
<a class="sourceLine" id="cb2-14" title="14">    }</a>
<a class="sourceLine" id="cb2-15" title="15">  )</a>
<a class="sourceLine" id="cb2-16" title="16">)</a></code></pre></div>
</div>
<div id="channel-definitions" class="section level3">
<h3 class="hasAnchor">
<a href="#channel-definitions" class="anchor"></a>Channel Definitions</h3>
<p>We need to tell the <code>PipeOp</code> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable. This is done on initialization of the <code>PipeOp</code> (using a <code>super$initialize</code> call) by giving the <code>input</code> and <code>output</code> <code>data.table</code> objects. These must have three columns: a <code>"name"</code> column giving the names of input and output channels, and a <code>"train"</code> and <code>"predict"</code> column naming the class of objects we expect during training and prediction as input / output. A special value for these classes is <code>"*"</code>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</p>
<p>By convention, we name a single channel <code>"input"</code> or <code>"output"</code>, and a group of channels [<code>"input1"</code>, <code>"input2"</code>, …], unless there is a reason to give specific different names. Therefore, our <code>input</code> <code>data.table</code> will have a single row <code>&lt;"input", "*", "*"&gt;</code>, and our <code>output</code> table will have two rows, <code>&lt;"output1", "*", "*"&gt;</code> and <code>&lt;"output2", "*", "*"&gt;</code>.</p>
<p>All of this is given to the <code>PipeOp</code> creator. Our <code>initialize()</code> will thus look as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">    initialize =<span class="st"> </span><span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"copy.two"</span>) {</a>
<a class="sourceLine" id="cb3-2" title="2">      input =<span class="st"> </span>data.table<span class="op">::</span><span class="kw">data.table</span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">train =</span> <span class="st">"*"</span>, <span class="dt">predict =</span> <span class="st">"*"</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">      <span class="co"># the following will create two rows and automatically fill the `train`</span></a>
<a class="sourceLine" id="cb3-4" title="4">      <span class="co"># and `predict` cols with "*"</span></a>
<a class="sourceLine" id="cb3-5" title="5">      output =<span class="st"> </span>data.table<span class="op">::</span><span class="kw">data.table</span>(</a>
<a class="sourceLine" id="cb3-6" title="6">        <span class="dt">name =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="dt">train =</span> <span class="st">"*"</span>, <span class="dt">predict =</span> <span class="st">"*"</span></a>
<a class="sourceLine" id="cb3-8" title="8">      )</a>
<a class="sourceLine" id="cb3-9" title="9">      super<span class="op">$</span><span class="kw">initialize</span>(id,</a>
<a class="sourceLine" id="cb3-10" title="10">        <span class="dt">input =</span> input,</a>
<a class="sourceLine" id="cb3-11" title="11">        <span class="dt">output =</span> output</a>
<a class="sourceLine" id="cb3-12" title="12">      )</a>
<a class="sourceLine" id="cb3-13" title="13">    }</a></code></pre></div>
</div>
<div id="train-and-predict" class="section level3">
<h3 class="hasAnchor">
<a href="#train-and-predict" class="anchor"></a>Train and Predict</h3>
<p>Both <code>train()</code> and <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict()</a></code> will receive a <code>list</code> as input and must give a <code>list</code> in return. According to our <code>input</code> and <code>output</code> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <code><a href="https://www.rdocumentation.org/packages/base/topics/c">c(inputs, inputs)</a></code>.</p>
<p>Two things to consider:</p>
<ul>
<li>The <code>train()</code> function must always modify the <code>self$state</code> variable to something that is not <code>NULL</code> or <code>NO_OP</code>. This is because the <code>$state</code> slot is used as a signal that <code>PipeOp</code> has been trained on data, even if the state itself is not important to the <code>PipeOp</code> (as in our case). Therefore, our <code>train()</code> will set <code>self$state = list()</code>.</li>
<li>It is not necessary to “clone” our input or make deep copies, because we don’t modify the data. However, if we were changing a reference-passed object, for example by changing data in a <code>Task</code>, we would have to make a deep copy first. This is because a <code>PipeOp</code> may never modify its input object by reference.</li>
</ul>
<p>Our <code>train()</code> and <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict()</a></code> functions are now:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">    train =<span class="st"> </span><span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb4-2" title="2">      self<span class="op">$</span>state =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()</a>
<a class="sourceLine" id="cb4-3" title="3">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(inputs, inputs)</a>
<a class="sourceLine" id="cb4-4" title="4">    },</a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6">    predict =<span class="st"> </span><span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb4-7" title="7">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(inputs, inputs)</a>
<a class="sourceLine" id="cb4-8" title="8">    }</a></code></pre></div>
</div>
<div id="putting-it-together" class="section level3">
<h3 class="hasAnchor">
<a href="#putting-it-together" class="anchor"></a>Putting it Together</h3>
<p>The whole definition thus becomes</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">PipeOpCopyTwo =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpCopyTwo"</span>,</a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="dt">inherit =</span> PipeOp,</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"copy.two"</span>) {</a>
<a class="sourceLine" id="cb5-5" title="5">      super<span class="op">$</span><span class="kw">initialize</span>(id,</a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="dt">input =</span> data.table<span class="op">::</span><span class="kw">data.table</span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">train =</span> <span class="st">"*"</span>, <span class="dt">predict =</span> <span class="st">"*"</span>),</a>
<a class="sourceLine" id="cb5-7" title="7">        <span class="dt">output =</span> data.table<span class="op">::</span><span class="kw">data.table</span>(<span class="dt">name =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</a>
<a class="sourceLine" id="cb5-8" title="8">                            <span class="dt">train =</span> <span class="st">"*"</span>, <span class="dt">predict =</span> <span class="st">"*"</span>)</a>
<a class="sourceLine" id="cb5-9" title="9">      )</a>
<a class="sourceLine" id="cb5-10" title="10">    },</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="dt">train =</span> <span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb5-13" title="13">      self<span class="op">$</span>state =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()</a>
<a class="sourceLine" id="cb5-14" title="14">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(inputs, inputs)</a>
<a class="sourceLine" id="cb5-15" title="15">    },</a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="dt">predict =</span> <span class="cf">function</span>(inputs) {</a>
<a class="sourceLine" id="cb5-18" title="18">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(inputs, inputs)</a>
<a class="sourceLine" id="cb5-19" title="19">    }</a>
<a class="sourceLine" id="cb5-20" title="20">  )</a>
<a class="sourceLine" id="cb5-21" title="21">)</a></code></pre></div>
<p>We can create an instance of our <code>PipeOp</code>, put it in a graph, and see what happens when we train it on something:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">poct =<span class="st"> </span>PipeOpCopyTwo<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb6-2" title="2">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb6-3" title="3">gr<span class="op">$</span><span class="kw">add_pipeop</span>(poct)</a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(gr)</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt; Graph with 1 PipeOps:</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt;        ID         State sccssors prdcssors</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt;  copy.two &lt;&lt;UNTRAINED&gt;&gt;</span></a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10">result =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(task)</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(result)</a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt;  $ copy.two.output1:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; </span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co">#&gt;  $ copy.two.output2:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt;</span></a></code></pre></div>
</div>
</div>
<div id="special-case-preprocessing" class="section level2">
<h2 class="hasAnchor">
<a href="#special-case-preprocessing" class="anchor"></a>Special Case: Preprocessing</h2>
<p>Many PipeOps perform an operation on exactly one <code>Task</code>, and return exactly one <code>Task</code>. They may even not care about the “Target” / “Outcome” variable of that task, and only do some modification of some input data. However, it is usually important to them that the <code>Task</code> on which they perform prediction has the same data columns as the <code>Task</code> on which they train. For these cases, the auxiliary base class <code>PipeOpTaskPreproc</code> exists. It inherits from <code>PipeOp</code> itself, and other PipeOps should use it if they fall in the kind of use-case named above.</p>
<p>When inheriting from <code>PipeOpTaskPreproc</code>, one must either implement the <code>train_task</code> and <code>predict_task</code> functions, or the <code>train_dt</code>, <code>predict_dt</code> functions, depending on whether wants to operate on a <code>Task</code> object or on <code>data.table</code>s. In the second case, one can optionally also overload the <code>select_cols</code> function, which chooses which of the incoming <code>Task</code>’s features are given to the <code>train_dt</code> / <code>predict_dt</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>, which removes a <code>Task</code>’s rows with missing values during training (and implements <code>train_task</code> and <code>predict_task</code>), and <code>PipeOpScale</code>, which scales a <code>Task</code>’s numeric columns (and implements <code>train_dt</code>, <code>predict_dt</code>, and <code>select_cols</code>).</p>
<div id="example-pipeopdropna" class="section level3">
<h3 class="hasAnchor">
<a href="#example-pipeopdropna" class="anchor"></a>Example: <code>PipeOpDropNA</code>
</h3>
<p>Dropping rows with missing values may be important when training a model that can not handle them.</p>
<p>Because <code>mlr3</code> <code>Task</code>s only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values. Instead, the rows can be removed using the <code>Task</code>’s <code>$filter</code> method, which modifies the <code>Task</code> in-place. This is done in the <code>train_task</code> function. We take care that we also set the <code>$state</code> slot to signal that the <code>PipeOp</code> was trained.</p>
<p>The <code>predict_task</code> function does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows. Furthermore, <code>mlr3</code> expects a <code>Learner</code> to always return just as many predictions as it was given input rows, so a <code>PipeOp</code> that removes <code>Task</code> rows during training can not be used inside a <code>GraphLearner</code>.</p>
<p>When we inherit from <code>PipeOpTaskPreproc</code>, it sets the <code>input</code> and <code>output</code> <code>data.table</code>s for us to only accept a single <code>Task</code>. The only thing we do during <code>initialize()</code> is therefore to set an <code>id</code> (which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as follows. Note that it inherits from <code>PipeOpTaskPreproc</code>, unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">PipeOpDropNA =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpDropNA"</span>,</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="dt">inherit =</span> PipeOpTaskPreproc,</a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"drop.na"</span>) {</a>
<a class="sourceLine" id="cb7-5" title="5">      super<span class="op">$</span><span class="kw">initialize</span>(id)</a>
<a class="sourceLine" id="cb7-6" title="6">    },</a>
<a class="sourceLine" id="cb7-7" title="7"></a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="dt">train_task =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb7-9" title="9">      self<span class="op">$</span>state =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()</a>
<a class="sourceLine" id="cb7-10" title="10">      featuredata =<span class="st"> </span>task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="dt">cols =</span> task<span class="op">$</span>feature_names)</a>
<a class="sourceLine" id="cb7-11" title="11">      exclude =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(featuredata), <span class="dv">1</span>, any)</a>
<a class="sourceLine" id="cb7-12" title="12">      task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(task<span class="op">$</span>row_ids[<span class="op">!</span>exclude])</a>
<a class="sourceLine" id="cb7-13" title="13">    },</a>
<a class="sourceLine" id="cb7-14" title="14"></a>
<a class="sourceLine" id="cb7-15" title="15">    <span class="dt">predict_task =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb7-16" title="16">      <span class="co"># nothing to be done</span></a>
<a class="sourceLine" id="cb7-17" title="17">      task</a>
<a class="sourceLine" id="cb7-18" title="18">    }</a>
<a class="sourceLine" id="cb7-19" title="19">  )</a>
<a class="sourceLine" id="cb7-20" title="20">)</a></code></pre></div>
<p>To test this <code>PipeOp</code>, we create a small task with missing values:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">smalliris =<span class="st"> </span>iris[(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>) <span class="op">*</span><span class="st"> </span><span class="dv">30</span>, ]</a>
<a class="sourceLine" id="cb8-2" title="2">smalliris[<span class="dv">1</span>, <span class="dv">1</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb8-3" title="3">smalliris[<span class="dv">2</span>, <span class="dv">2</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb8-4" title="4">sitask =<span class="st"> </span>TaskClassif<span class="op">$</span><span class="kw">new</span>(<span class="st">"smalliris"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/mlr3/topics/as_data_backend">as_data_backend</a></span>(smalliris), <span class="st">"Species"</span>)</a>
<a class="sourceLine" id="cb8-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(sitask<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>())</a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt;       Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt; 1:     setosa          1.6         0.2           NA         3.2</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#&gt; 2: versicolor          3.9         1.4          5.2          NA</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#&gt; 3: versicolor          4.0         1.3          5.5         2.5</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">#&gt; 4:  virginica          5.0         1.5          6.0         2.2</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#&gt; 5:  virginica          5.1         1.8          5.9         3.0</span></a></code></pre></div>
<p>We test this by feeding it to a new <code>Graph</code> that uses <code>PipeOpDropNA</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb9-2" title="2">gr<span class="op">$</span><span class="kw">add_pipeop</span>(PipeOpDropNA<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4">filtered_task =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(sitask)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(filtered_task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>())</a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">#&gt;       Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">#&gt; 1: versicolor          4.0         1.3          5.5         2.5</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">#&gt; 2:  virginica          5.0         1.5          6.0         2.2</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">#&gt; 3:  virginica          5.1         1.8          5.9         3.0</span></a></code></pre></div>
</div>
<div id="example-pipeopscalealways" class="section level3">
<h3 class="hasAnchor">
<a href="#example-pipeopscalealways" class="anchor"></a>Example: <code>PipeOpScaleAlways</code>
</h3>
<p>An often-applied preprocessing step is to simply <strong>center</strong> and/or <strong>scale</strong> the data to mean <span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>. This fits the <code>PipeOpTaskPreproc</code> pattern quite well. Because it always replaces all columns that it operates on, and does not require any information about the task’s target, it only needs to overload the <code>train_dt</code> and <code>predict_dt</code> functions. This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to instruct <code>PipeOpTaskPreproc</code> to give us only these numeric columns. We do this by overloading the <code>select_cols</code> function: It is called by the class to determine which columns to give to <code>train_dt</code> and <code>predict_dt</code>. Its input is the <code>Task</code> that is being transformed, and it should return a <code>character</code> vector of all features to work with. When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns. Because the <code><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels()</a></code> of the data table given to <code>train_dt</code> and <code>predict_dt</code> may be different from the levels <code>task</code>’s levels, these functions must also take a <code>levels</code> argument that is a named list of column names indicating their levels. When working with numeric data, this argument can be ignored, but it should be used instead of <code><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels(dt[[column]])</a></code> for factorial or character columns.</p>
<p>This is the first <code>PipeOp</code> where we will be using the <code>$state</code> slot for something useful: We save the centering offset and scaling coefficient and use it in <code>$predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always scale and center all data. Compare this <code>PipeOpScaleAlways</code> operator to the one defined inside the <code>mlr3pipelines</code> package, <code>PipeOpScale</code>, defined in <code>PipeOpScale.R</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">PipeOpScaleAlways =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpScaleAlways"</span>,</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="dt">inherit =</span> PipeOpTaskPreproc,</a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"scale.always"</span>) {</a>
<a class="sourceLine" id="cb10-5" title="5">      super<span class="op">$</span><span class="kw">initialize</span>(<span class="dt">id =</span> id)</a>
<a class="sourceLine" id="cb10-6" title="6">    },</a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8">    <span class="dt">select_cols =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb10-9" title="9">      task<span class="op">$</span>feature_types[type <span class="op">==</span><span class="st"> "numeric"</span>, id]</a>
<a class="sourceLine" id="cb10-10" title="10">    },</a>
<a class="sourceLine" id="cb10-11" title="11"></a>
<a class="sourceLine" id="cb10-12" title="12">    <span class="dt">train_dt =</span> <span class="cf">function</span>(dt, levels) {</a>
<a class="sourceLine" id="cb10-13" title="13">      sc =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/scale">scale</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(dt))</a>
<a class="sourceLine" id="cb10-14" title="14">      self<span class="op">$</span>state =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb10-15" title="15">        <span class="dt">center =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(sc, <span class="st">"scaled:center"</span>),</a>
<a class="sourceLine" id="cb10-16" title="16">        <span class="dt">scale =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(sc, <span class="st">"scaled:scale"</span>)</a>
<a class="sourceLine" id="cb10-17" title="17">      )</a>
<a class="sourceLine" id="cb10-18" title="18">      sc</a>
<a class="sourceLine" id="cb10-19" title="19">    },</a>
<a class="sourceLine" id="cb10-20" title="20"></a>
<a class="sourceLine" id="cb10-21" title="21">    <span class="dt">predict_dt =</span> <span class="cf">function</span>(dt, levels) {</a>
<a class="sourceLine" id="cb10-22" title="22">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>((<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(dt) <span class="op">-</span><span class="st"> </span>self<span class="op">$</span>state<span class="op">$</span>center) <span class="op">/</span><span class="st"> </span>self<span class="op">$</span>state<span class="op">$</span>scale)</a>
<a class="sourceLine" id="cb10-23" title="23">    }</a>
<a class="sourceLine" id="cb10-24" title="24">  )</a>
<a class="sourceLine" id="cb10-25" title="25">)</a></code></pre></div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code> from the <code>mlr3pipelines</code> package, you will notice that is uses “<code><a href="https://www.rdocumentation.org/packages/base/topics/get">get("type")</a></code>” and “<code><a href="https://www.rdocumentation.org/packages/base/topics/get">get("id")</a></code>” instead of “<code>type</code>” and “<code>id</code>”, because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a “problem” with <code>data.table</code> and not exclusive to <code>mlr3pipelines</code>.)</em></p>
<p>We can, again, create a new <code>Graph</code> that uses this <code>PipeOp</code> to test it. Compare the resulting data to the original “iris” <code>Task</code> data printed at the beginning:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb11-2" title="2">gr<span class="op">$</span><span class="kw">add_pipeop</span>(PipeOpScaleAlways<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4">result =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(task)</a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6">result[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">#&gt;        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">#&gt;   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#&gt;   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt;   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt;   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt;   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt;  ---                                                            </span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt; 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#&gt; 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co">#&gt; 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co">#&gt; 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">#&gt; 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></a></code></pre></div>
</div>
</div>
<div id="special-case-preprocessing-with-simple-train" class="section level2">
<h2 class="hasAnchor">
<a href="#special-case-preprocessing-with-simple-train" class="anchor"></a>Special Case: Preprocessing with Simple Train</h2>
<p>It is possible to make even further simplifications for many <code>PipeOp</code>s that perform mostly the same operation during training and prediction. The point of <code>Task</code> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level. However, what features get removed must be decided during <em>training</em>, and may only depend on training data. Furthermore, the actual process of removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a function <code>get_state(task)</code> which sets the <code>$state</code> slot during training, and a <code><a href="https://www.rdocumentation.org/packages/base/topics/transform">transform(task)</a></code> function, which gets called both during training <em>and</em> prediction. This is done in the <code>PipeOpTaskPreprocSimple</code> class. Just like <code>PipeOpTaskPreproc</code>, one can inherit from this and overload these functions to get a <code>PipeOp</code> that performs preprocessing with very little boilerplate code.</p>
<p>Just like <code>PipeOpTaskPreproc</code>, <code>PipeOpTaskPreprocSimple</code> offers the possibility to instead overload the <code>get_state_dt(dt, levels)</code> and <code>transform_dt(dt, levels)</code> functions (and optionally, again, the <code>select_cols(task)</code> function) to operate on <code>data.table</code> feature data instead of the whole <code>Task</code>.</p>
<p>Even some methods that do not use <code>PipeOpTaskPreprocSimple</code> <em>could</em> work in a similar way: The <code>PipeOpScaleAlways</code> example from above will be shown to also work with this paradigm.</p>
<div id="example-pipeopdropconst" class="section level3">
<h3 class="hasAnchor">
<a href="#example-pipeopdropconst" class="anchor"></a>Example: <code>PipeOpDropConst</code>
</h3>
<p>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training. One simple example of this is dropping constant features. Because the <code>mlr3</code> <code>Task</code> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <code>$select()</code> function, so the <code>get_state_dt(dt, levels)</code> / <code>transform_dt(dt, levels)</code> functions will <em>not</em> get used; instead we overload the <code>get_state(task)</code> and <code><a href="https://www.rdocumentation.org/packages/base/topics/transform">transform(task)</a></code> functions.</p>
<p>The <code>get_state()</code> function’s result is saved to the <code>$state</code> slot, so we want to return something that is useful for dropping features. We choose to save the names of all the columns that have nonzero variance. For brevity, we use <code>length(unique(column)) &gt; 1</code> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</p>
<p>The <code><a href="https://www.rdocumentation.org/packages/base/topics/transform">transform()</a></code> function is evaluated both during training <em>and</em> prediction, and can rely on the <code>$state</code> slot being present. All it does here is call the <code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <code>PipeOp</code> could be written as follows:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">PipeOpDropConst =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpDropConst"</span>,</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="dt">inherit =</span> PipeOpTaskPreprocSimple,</a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"drop.const"</span>) {</a>
<a class="sourceLine" id="cb12-5" title="5">      super<span class="op">$</span><span class="kw">initialize</span>(<span class="dt">id =</span> id)</a>
<a class="sourceLine" id="cb12-6" title="6">    },</a>
<a class="sourceLine" id="cb12-7" title="7"></a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="dt">get_state =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb12-9" title="9">      data =<span class="st"> </span>task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="dt">cols =</span> task<span class="op">$</span>feature_names)</a>
<a class="sourceLine" id="cb12-10" title="10">      nonconst =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(data, <span class="cf">function</span>(column) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(column)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-11" title="11">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(data)[nonconst]</a>
<a class="sourceLine" id="cb12-12" title="12">    },</a>
<a class="sourceLine" id="cb12-13" title="13"></a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="dt">transform =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb12-15" title="15">      task<span class="op">$</span><span class="kw">select</span>(self<span class="op">$</span>state)</a>
<a class="sourceLine" id="cb12-16" title="16">    }</a>
<a class="sourceLine" id="cb12-17" title="17">  )</a>
<a class="sourceLine" id="cb12-18" title="18">)</a></code></pre></div>
<p>This can be tested using the first five rows of the “Iris” <code>Task</code>, for which one feature (<code>"Petal.Width"</code>) is constant:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">irishead =<span class="st"> </span>task<span class="op">$</span><span class="kw">clone</span>()<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb13-2" title="2">irishead<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="co">#&gt;    Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">#&gt; 1:  setosa          1.4         0.2          5.1         3.5</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co">#&gt; 2:  setosa          1.4         0.2          4.9         3.0</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co">#&gt; 3:  setosa          1.3         0.2          4.7         3.2</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">#&gt; 4:  setosa          1.5         0.2          4.6         3.1</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">#&gt; 5:  setosa          1.4         0.2          5.0         3.6</span></a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()<span class="op">$</span><span class="kw">add_pipeop</span>(PipeOpDropConst<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb14-2" title="2">dropped_task =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(irishead)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4">dropped_task<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">#&gt;    Species Petal.Length Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#&gt; 1:  setosa          1.4          5.1         3.5</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">#&gt; 2:  setosa          1.4          4.9         3.0</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">#&gt; 3:  setosa          1.3          4.7         3.2</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">#&gt; 4:  setosa          1.5          4.6         3.1</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co">#&gt; 5:  setosa          1.4          5.0         3.6</span></a></code></pre></div>
<p>We can also see that the <code>$state</code> was correctly set. Calling <code>$predict()</code> with this graph, even with different data (the whole Iris <code>Task</code>!) will still drop the <code>"Petal.Width"</code> column, as it should.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">gr<span class="op">$</span>pipeops<span class="op">$</span>drop.const<span class="op">$</span>state</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">#&gt; [1] "Petal.Length" "Sepal.Length" "Sepal.Width"</span></a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">dropped_predict =<span class="st"> </span>gr<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(task)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3">dropped_predict<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">#&gt;        Species Petal.Length Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">#&gt;   1:    setosa          1.4          5.1         3.5</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">#&gt;   2:    setosa          1.4          4.9         3.0</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">#&gt;   3:    setosa          1.3          4.7         3.2</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="co">#&gt;   4:    setosa          1.5          4.6         3.1</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">#&gt;   5:    setosa          1.4          5.0         3.6</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="co">#&gt;  ---                                                </span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="co">#&gt; 146: virginica          5.2          6.7         3.0</span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="co">#&gt; 147: virginica          5.0          6.3         2.5</span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="co">#&gt; 148: virginica          5.2          6.5         3.0</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="co">#&gt; 149: virginica          5.4          6.2         3.4</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="co">#&gt; 150: virginica          5.1          5.9         3.0</span></a></code></pre></div>
</div>
<div id="example-pipeopscalealwayssimple" class="section level3">
<h3 class="hasAnchor">
<a href="#example-pipeopscalealwayssimple" class="anchor"></a>Example: <code>PipeOpScaleAlwaysSimple</code>
</h3>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can be used when only working on feature data in form of a <code>data.table</code>. Instead of calling the <code><a href="https://www.rdocumentation.org/packages/base/topics/scale">scale()</a></code> function, the <code>center</code> and <code>scale</code> values are calculated directly and saved to the <code>$state</code> slot. The <code>transform_dt</code> function will then perform the same operation during both training and prediction: subtract the <code>center</code> and divide by the <code>scale</code> value. As in the <a href="#example-pipeopscalealways"><code>PipeOpScaleAlways</code> example above</a>, we use <code>select_cols()</code> so that we only work on numeric columns.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">PipeOpScaleAlwaysSimple =<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"PipeOpScaleAlwaysSimple"</span>,</a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="dt">inherit =</span> PipeOpTaskPreprocSimple,</a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb17-4" title="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">id =</span> <span class="st">"scale.always.simple"</span>) {</a>
<a class="sourceLine" id="cb17-5" title="5">      super<span class="op">$</span><span class="kw">initialize</span>(<span class="dt">id =</span> id)</a>
<a class="sourceLine" id="cb17-6" title="6">    },</a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8">    <span class="dt">select_cols =</span> <span class="cf">function</span>(task) {</a>
<a class="sourceLine" id="cb17-9" title="9">      task<span class="op">$</span>feature_types[type <span class="op">==</span><span class="st"> "numeric"</span>, id]</a>
<a class="sourceLine" id="cb17-10" title="10">    },</a>
<a class="sourceLine" id="cb17-11" title="11"></a>
<a class="sourceLine" id="cb17-12" title="12">    <span class="dt">get_state_dt =</span> <span class="cf">function</span>(dt, levels) {</a>
<a class="sourceLine" id="cb17-13" title="13">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb17-14" title="14">        <span class="dt">center =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(dt, mean),</a>
<a class="sourceLine" id="cb17-15" title="15">        <span class="dt">scale =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(dt, sd)</a>
<a class="sourceLine" id="cb17-16" title="16">      )</a>
<a class="sourceLine" id="cb17-17" title="17">    },</a>
<a class="sourceLine" id="cb17-18" title="18"></a>
<a class="sourceLine" id="cb17-19" title="19">    <span class="dt">transform_dt =</span> <span class="cf">function</span>(dt, levels) {</a>
<a class="sourceLine" id="cb17-20" title="20">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>((<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(dt) <span class="op">-</span><span class="st"> </span>self<span class="op">$</span>state<span class="op">$</span>center) <span class="op">/</span><span class="st"> </span>self<span class="op">$</span>state<span class="op">$</span>scale)</a>
<a class="sourceLine" id="cb17-21" title="21">    }</a>
<a class="sourceLine" id="cb17-22" title="22">  )</a>
<a class="sourceLine" id="cb17-23" title="23">)</a></code></pre></div>
<p>We can compare this <code>PipeOp</code> to the one above to show that it behaves the same.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()<span class="op">$</span><span class="kw">add_pipeop</span>(PipeOpScaleAlways<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb18-2" title="2">result_posa =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(task)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()<span class="op">$</span><span class="kw">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb18-5" title="5">result_posa_simple =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(task)[[<span class="dv">1</span>]]</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">result_posa<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">#&gt;        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">#&gt;   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt;   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt;   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">#&gt;   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">#&gt;   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">#&gt;  ---                                                            </span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co">#&gt; 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="co">#&gt; 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co">#&gt; 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="co">#&gt; 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="co">#&gt; 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">result_posa_simple<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">#&gt;        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">#&gt;   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co">#&gt;   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#&gt;   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="co">#&gt;   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co">#&gt;   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co">#&gt;  ---                                                            </span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co">#&gt; 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co">#&gt; 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co">#&gt; 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">#&gt; 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="co">#&gt; 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></a></code></pre></div>
</div>
</div>
<div id="hyperparameters" class="section level2">
<h2 class="hasAnchor">
<a href="#hyperparameters" class="anchor"></a>Hyperparameters</h2>
<p><code>mlr3pipelines</code> uses the <a href="https://github.com/mlr-org/paradox"><code>paradox</code></a> package to define parameter spaces for <code>PipeOp</code>s. Parameters for <code>PipeOp</code>s can modify their behaviour in certain ways, e.g. switch centering or scaling off in the <code>PipeOpScale</code> operator. The unified interface makes it possible to have parameters for whole <code>Graph</code>s that modify the individual <code>PipeOp</code>’s behaviour. The <code>Graph</code>s, when encapsuled in <code>GraphLearner</code>s, can even be tuned using the tuning functionality in <a href="https://github.com/mlr-org/mlr3tuning"><code>mlr3tuning</code></a>.</p>
<p>Hyperparameters are declared during initialization, when calling the <code>PipeOp</code>’s <code>$initialize()</code> function, by giving a <code>param_set</code> argument. The <code>param_set</code> must be a <code>ParamSet</code> from the <code>paradox</code> package; see the <a href="https://mlr-org.github.io/paradox/articles/paradox.html">vignette</a> for more information on how to define parameter spaces. After construction, the <code>ParamSet</code> can be accessed through the <code>$param_set</code> slot. While it is <em>possible</em> to modify this <code>ParamSet</code>, using e.g. the <code>$add()</code> and <code>$add_dep()</code> functions, <em>after</em> adding it to the <code>PipeOp</code>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the <code>$values</code> slot. When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <code>$param_set</code>, so it is not necessary to type check them. Be aware that it is always possible to <em>remove</em> hyperparameter values.</p>
<p>When a <code>PipeOp</code> is initialized, it usually does not have any parameter values—<code>$values</code> takes the value <code><a href="https://www.rdocumentation.org/packages/base/topics/list">list()</a></code>. It is possible to set initial parameter values in the <code>$initialize()</code> constructor; this must be done <em>after</em> the <code>super$initialize()</code> call where the corresponding <code>ParamSet</code> must be supplied. This is because setting <code>$values</code> checks against the current <code>$param_set</code>, which would fail if the <code>$param_set</code> was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code> function in <code>PipeOpScale</code>, say), then there is usually a “default” behaviour of that function when a parameter is not given. It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed). This can easily be done when using the <a href="https://github.com/mlr-org/mlr3misc"><code>mlr3misc</code></a> library’s <code>invoke()</code> function, which has functionality similar to <code><a href="https://www.rdocumentation.org/packages/base/topics/do.call">base::do.call()</a></code>.</p>
<div id="hyperparameter-example-pipeopscale" class="section level3">
<h3 class="hasAnchor">
<a href="#hyperparameter-example-pipeopscale" class="anchor"></a>Hyperparameter Example: <code>PipeOpScale</code>
</h3>
<p>How to use hyperparameters can best be shown through the example of <code>PipeOpScale</code>, which is very similar to the example above, <code>PipeOpScaleAlways</code>. The difference is made by the presence of hyperparameters. <code>PipeOpScale</code> constructs a <code>ParamSet</code> in its <code>$initialize</code> function and passes this on to the <code>super$initialize</code> function:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">PipeOpScale<span class="op">$</span>public_methods<span class="op">$</span>initialize</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">#&gt; function (id = "scale", param_vals = list()) </span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co">#&gt;     ps = ParamSet$new(params = list(ParamLgl$new("center", default = TRUE), </span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">#&gt;         ParamLgl$new("scale", default = TRUE)))</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">#&gt;     super$initialize(id = id, param_set = ps, param_vals = param_vals)</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">#&gt; &lt;bytecode: 0x6a62998&gt;</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">#&gt; &lt;environment: namespace:mlr3pipelines&gt;</span></a></code></pre></div>
<p>The user has access to this and can set and get parameters. Types are automatically checked:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">pss =<span class="st"> </span>PipeOpScale<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(pss<span class="op">$</span>param_set)</a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">#&gt; ParamSet: scale</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="co">#&gt;        id    class lower upper      levels default value</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co">#&gt; 1: center ParamLgl    NA    NA  TRUE,FALSE    TRUE      </span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co">#&gt; 2:  scale ParamLgl    NA    NA  TRUE,FALSE    TRUE</span></a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">pss<span class="op">$</span>values<span class="op">$</span>center =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(pss<span class="op">$</span>values)</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="co">#&gt; $center</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">pss<span class="op">$</span>values<span class="op">$</span>scale =<span class="st"> "TRUE"</span>  <span class="co"># bad input is checked!</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="co">#&gt; Error in (function (xs) : Assertion on 'x' failed: scale: Must be of type 'logical flag', not 'character'.</span></a></code></pre></div>
<p>How <code>PipeOpScale</code> handles its parameters can be seen in its <code>$train</code> method: It gets the relevant parameters from its <code>$values</code> slot and uses them in the <code><a href="https://www.rdocumentation.org/packages/mlr3misc/topics/invoke">mlr3misc::invoke</a></code> call. This has the advantage over calling <code><a href="https://www.rdocumentation.org/packages/base/topics/scale">scale()</a></code> directly that if a parameter is not given, its default value from the <code><a href="https://www.rdocumentation.org/packages/base/topics/scale">base::scale</a></code> function will be used.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">PipeOpScale<span class="op">$</span>public_methods<span class="op">$</span>train</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="co">#&gt; function (dt, levels) </span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="co">#&gt;     sc = invoke(scale, as.matrix(dt), .args = self$param_set$values)</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="co">#&gt;     self$state = list(center = attr(sc, "scaled:center") %??% </span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="co">#&gt;         0, scale = attr(sc, "scaled:scale") %??% 1)</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="co">#&gt;     constfeat = self$state$scale == 0</span></a>
<a class="sourceLine" id="cb25-8" title="8"><span class="co">#&gt;     self$state$scale[constfeat] = 1</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="co">#&gt;     sc[, constfeat] = 0</span></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="co">#&gt;     sc</span></a>
<a class="sourceLine" id="cb25-11" title="11"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb25-12" title="12"><span class="co">#&gt; &lt;bytecode: 0x6a5fc18&gt;</span></a>
<a class="sourceLine" id="cb25-13" title="13"><span class="co">#&gt; &lt;environment: namespace:mlr3pipelines&gt;</span></a></code></pre></div>
<p>Another change that is necessary compared to <code>PipeOpScaleAlways</code> is that the attributes <code>"scaled:scale"</code> and <code>"scaled:center"</code> are not always present, depending on parameters, and possibly need to be set to default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call <code>PipeOpScale</code> with both <code>scale</code> and <code>center</code> set to <code>FALSE</code>, which returns the original dataset, unchanged.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">pss<span class="op">$</span>values<span class="op">$</span>scale =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb26-2" title="2">pss<span class="op">$</span>values<span class="op">$</span>center =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb26-3" title="3"></a>
<a class="sourceLine" id="cb26-4" title="4">gr =<span class="st"> </span>Graph<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb26-5" title="5">gr<span class="op">$</span><span class="kw">add_pipeop</span>(pss)</a>
<a class="sourceLine" id="cb26-6" title="6"></a>
<a class="sourceLine" id="cb26-7" title="7">result =<span class="st"> </span>gr<span class="op">$</span><span class="kw">train</span>(task)</a>
<a class="sourceLine" id="cb26-8" title="8"></a>
<a class="sourceLine" id="cb26-9" title="9">result[[<span class="dv">1</span>]]<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>()</a>
<a class="sourceLine" id="cb26-10" title="10"><span class="co">#&gt;        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="co">#&gt;   1:    setosa          1.4         0.2          5.1         3.5</span></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="co">#&gt;   2:    setosa          1.4         0.2          4.9         3.0</span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="co">#&gt;   3:    setosa          1.3         0.2          4.7         3.2</span></a>
<a class="sourceLine" id="cb26-14" title="14"><span class="co">#&gt;   4:    setosa          1.5         0.2          4.6         3.1</span></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co">#&gt;   5:    setosa          1.4         0.2          5.0         3.6</span></a>
<a class="sourceLine" id="cb26-16" title="16"><span class="co">#&gt;  ---                                                            </span></a>
<a class="sourceLine" id="cb26-17" title="17"><span class="co">#&gt; 146: virginica          5.2         2.3          6.7         3.0</span></a>
<a class="sourceLine" id="cb26-18" title="18"><span class="co">#&gt; 147: virginica          5.0         1.9          6.3         2.5</span></a>
<a class="sourceLine" id="cb26-19" title="19"><span class="co">#&gt; 148: virginica          5.2         2.0          6.5         3.0</span></a>
<a class="sourceLine" id="cb26-20" title="20"><span class="co">#&gt; 149: virginica          5.4         2.3          6.2         3.4</span></a>
<a class="sourceLine" id="cb26-21" title="21"><span class="co">#&gt; 150: virginica          5.1         1.8          5.9         3.0</span></a></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#how-things-work-around-here">How Things Work Around Here</a></li>
      <li>
<a href="#general-case-example-pipeopcopy">General Case Example: <code>PipeOpCopy</code></a><ul class="nav nav-pills nav-stacked">
<li><a href="#first-steps-inheriting-from-pipeop">First Steps: Inheriting from <code>PipeOp</code></a></li>
      <li><a href="#channel-definitions">Channel Definitions</a></li>
      <li><a href="#train-and-predict">Train and Predict</a></li>
      <li><a href="#putting-it-together">Putting it Together</a></li>
      </ul>
</li>
      <li>
<a href="#special-case-preprocessing">Special Case: Preprocessing</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-pipeopdropna">Example: <code>PipeOpDropNA</code></a></li>
      <li><a href="#example-pipeopscalealways">Example: <code>PipeOpScaleAlways</code></a></li>
      </ul>
</li>
      <li>
<a href="#special-case-preprocessing-with-simple-train">Special Case: Preprocessing with Simple Train</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-pipeopdropconst">Example: <code>PipeOpDropConst</code></a></li>
      <li><a href="#example-pipeopscalealwayssimple">Example: <code>PipeOpScaleAlwaysSimple</code></a></li>
      </ul>
</li>
      <li>
<a href="#hyperparameters">Hyperparameters</a><ul class="nav nav-pills nav-stacked">
<li><a href="#hyperparameter-example-pipeopscale">Hyperparameter Example: <code>PipeOpScale</code></a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><!--<div class="copyright">
  <p>Developed by Martin Binder.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>
--></footer>
</div>

   

  </body>
</html>
