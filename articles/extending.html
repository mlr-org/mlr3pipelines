<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adding new PipeOps • mlr3pipelines</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adding new PipeOps">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mlr3pipelines</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.7.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-alt"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/extending.html">Adding new PipeOps</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr3book.mlr-org.com"><span class="fa fa-link"></span> mlr3book</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/mlr3pipelines/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/"><span class="fa fa-comments"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr-org.com/"><span class="fa fa-rss"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Adding new PipeOps</h1>
                        <h4 data-toc-skip class="author">Martin
Binder</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3pipelines/blob/master/vignettes/extending.Rmd" class="external-link"><code>vignettes/extending.Rmd</code></a></small>
      <div class="d-none name"><code>extending.Rmd</code></div>
    </div>

    
    
<p>This vignette showcases how the <code>mlr3pipelines</code> package
can be extended to include custom <code>PipeOp</code>s. To run the
following examples, we will need a <code>Task</code>; we are using the
well-known “Iris” task:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com" class="external-link">"mlr3"</a></span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa          1.4         0.2          5.1         3.5</span></span>
<span><span class="co">##   2:    setosa          1.4         0.2          4.9         3.0</span></span>
<span><span class="co">##   3:    setosa          1.3         0.2          4.7         3.2</span></span>
<span><span class="co">##   4:    setosa          1.5         0.2          4.6         3.1</span></span>
<span><span class="co">##   5:    setosa          1.4         0.2          5.0         3.6</span></span>
<span><span class="co">##  ---                                                            </span></span>
<span><span class="co">## 146: virginica          5.2         2.3          6.7         3.0</span></span>
<span><span class="co">## 147: virginica          5.0         1.9          6.3         2.5</span></span>
<span><span class="co">## 148: virginica          5.2         2.0          6.5         3.0</span></span>
<span><span class="co">## 149: virginica          5.4         2.3          6.2         3.4</span></span>
<span><span class="co">## 150: virginica          5.1         1.8          5.9         3.0</span></span></code></pre>
<p><code>mlr3pipelines</code> is fundamentally built around <a href="https://r6.r-lib.org/" class="external-link"><code>R6</code></a>. When planning to
create custom <code>PipeOp</code> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html" class="external-link">familiarize yourself with
it</a>.</p>
<p>In principle, all a <code>PipeOp</code> must do is inherit from the
<code>PipeOp</code> R6 class and implement the <code>.train()</code> and
<code>.predict()</code> functions. There are, however, several auxiliary
subclasses that can make the creation of <em>certain</em> operations
much easier.</p>
<div class="section level3">
<h3 id="ext-pipeopcopy">General Case Example: <code>PipeOpCopy</code><a class="anchor" aria-label="anchor" href="#ext-pipeopcopy"></a>
</h3>
<p>A very simple yet useful <code>PipeOp</code> is
<code>PipeOpCopy</code>, which takes a single input and creates a
variable number of output channels, all of which receive a copy of the
input data. It is a simple example that showcases the important steps in
defining a custom <code>PipeOp</code>. We will show a simplified version
here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly
two copies of its input data.</p>
<div class="section level4">
<h4 id="first-steps-inheriting-from-pipeop">First Steps: Inheriting from <code>PipeOp</code><a class="anchor" aria-label="anchor" href="#first-steps-inheriting-from-pipeop"></a>
</h4>
<p>The first part of creating a custom <code>PipeOp</code> is inheriting
from <code>PipeOp</code>. We make a mental note that we need to
implement a <code>.train()</code> and a <code>.predict()</code>
function, and that we probably want to have an <code>initialize()</code>
as well:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpCopyTwo</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpCopyTwo"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOp.html">PipeOp</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">....</span></span>
<span>    <span class="op">}</span>,</span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="va">private</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">....</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">....</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note, that <strong>private</strong> methods, e.g. <code>.train</code>
and <code>.predict</code> etc are prefixed with a <code>.</code>.</p>
</div>
<div class="section level4">
<h4 id="channel-definitions">Channel Definitions<a class="anchor" aria-label="anchor" href="#channel-definitions"></a>
</h4>
<p>We need to tell the <code>PipeOp</code> the layout of its channels:
How many there are, what their names are going to be, and what types are
acceptable. This is done on initialization of the <code>PipeOp</code>
(using a <code>super$initialize</code> call) by giving the
<code>input</code> and <code>output</code> <code>data.table</code>
objects. These must have three columns: a <code>"name"</code> column
giving the names of input and output channels, and a
<code>"train"</code> and <code>"predict"</code> column naming the class
of objects we expect during training and prediction as input / output. A
special value for these classes is <code>"*"</code>, which indicates
that any class will be accepted; our simple copy operator accepts any
kind of input, so this will be useful. We have only one input, but two
output channels.</p>
<p>By convention, we name a single channel <code>"input"</code> or
<code>"output"</code>, and a group of channels [<code>"input1"</code>,
<code>"input2"</code>, …], unless there is a reason to give specific
different names. Therefore, our <code>input</code>
<code>data.table</code> will have a single row
<code>&lt;"input", "*", "*"&gt;</code>, and our <code>output</code>
table will have two rows, <code>&lt;"output1", "*", "*"&gt;</code> and
<code>&lt;"output2", "*", "*"&gt;</code>.</p>
<p>All of this is given to the <code>PipeOp</code> creator. Our
<code>initialize()</code> will thus look as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">input</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"input"</span>, train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span></span>
<span>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span>  <span class="co"># and `predict` cols with "*"</span></span>
<span>  <span class="va">output</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"output1"</span>, <span class="st">"output2"</span><span class="op">)</span>,</span>
<span>    train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span>,</span>
<span>    input <span class="op">=</span> <span class="va">input</span>,</span>
<span>    output <span class="op">=</span> <span class="va">output</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="train-and-predict">Train and Predict<a class="anchor" aria-label="anchor" href="#train-and-predict"></a>
</h4>
<p>Both <code>.train()</code> and <code>.predict()</code> will receive a
<code>list</code> as input and must give a <code>list</code> in return.
According to our <code>input</code> and <code>output</code> definitions,
we will always get a list with a single element as input, and will need
to return a list with two elements. Because all we want to do is create
two copies, we will just create the copies using
<code>c(inputs, inputs)</code>.</p>
<p>Two things to consider:</p>
<ul>
<li><p>The <code>.train()</code> function must always modify the
<code>self$state</code> variable to something that is not
<code>NULL</code> or <code>NO_OP</code>. This is because the
<code>$state</code> slot is used as a signal that <code>PipeOp</code>
has been trained on data, even if the state itself is not important to
the <code>PipeOp</code> (as in our case). Therefore, our
<code>.train()</code> will set
<code>self$state = list()</code>.</p></li>
<li><p>It is not necessary to “clone” our input or make deep copies,
because we don’t modify the data. However, if we were changing a
reference-passed object, for example by changing data in a
<code>Task</code>, we would have to make a deep copy first. This is
because a <code>PipeOp</code> may never modify its input object by
reference.</p></li>
</ul>
<p>Our <code>.train()</code> and <code>.predict()</code> functions are
now:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.train</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.predict</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="putting-it-together">Putting it Together<a class="anchor" aria-label="anchor" href="#putting-it-together"></a>
</h4>
<p>The whole definition thus becomes</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpCopyTwo</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpCopyTwo"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOp.html">PipeOp</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span>,</span>
<span>        input <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"input"</span>, train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span>,</span>
<span>        output <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"output1"</span>, <span class="st">"output2"</span><span class="op">)</span>,</span>
<span>                            train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can create an instance of our <code>PipeOp</code>, put it in a
graph, and see what happens when we train it on something:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3pipelines.mlr-org.com">"mlr3pipelines"</a></span><span class="op">)</span></span>
<span><span class="va">poct</span> <span class="op">=</span> <span class="va">PipeOpCopyTwo</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">poct</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Graph with 1 PipeOps:</span></span>
<span><span class="co">##        ID         State sccssors prdcssors</span></span>
<span><span class="co">##    &lt;char&gt;        &lt;char&gt;   &lt;char&gt;    &lt;char&gt;</span></span>
<span><span class="co">##  copy.two &lt;&lt;UNTRAINED&gt;&gt;</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 2</span></span>
<span><span class="co">##  $ copy.two.output1:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; </span></span>
<span><span class="co">##  $ copy.two.output2:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt;</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="ext-pipe-preproc">Special Case: Preprocessing<a class="anchor" aria-label="anchor" href="#ext-pipe-preproc"></a>
</h3>
<p>Many <code>PipeOp</code>s perform an operation on exactly one
<code>Task</code>, and return exactly one <code>Task</code>. They may
even not care about the “Target” / “Outcome” variable of that task, and
only do some modification of some input data. However, it is usually
important to them that the <code>Task</code> on which they perform
prediction has the same data columns as the <code>Task</code> on which
they train. For these cases, the auxiliary base class
<code>PipeOpTaskPreproc</code> exists. It inherits from
<code>PipeOp</code> itself, and other <code>PipeOp</code>s should use it
if they fall in the kind of use-case named above.</p>
<p>When inheriting from <code>PipeOpTaskPreproc</code>, one must either
implement the private methods <code>.train_task()</code> and
<code>.predict_task()</code>, or the methods <code>.train_dt()</code>,
<code>.predict_dt()</code>, depending on whether wants to operate on a
<code>Task</code> object or on its data as <code>data.table</code>s. In
the second case, one can optionally also overload the
<code>.select_cols()</code> method, which chooses which of the incoming
<code>Task</code>’s features are given to the <code>.train_dt()</code> /
<code>.predict_dt()</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>,
which removes a <code>Task</code>’s rows with missing values during
training (and implements <code>.train_task()</code> and
<code>.predict_task()</code>), and <code>PipeOpScale</code>, which
scales a <code>Task</code>’s numeric columns (and implements
<code>.train_dt()</code>, <code>.predict_dt()</code>, and
<code>.select_cols()</code>).</p>
<div class="section level4">
<h4 id="example-pipeopdropna">Example: <code>PipeOpDropNA</code><a class="anchor" aria-label="anchor" href="#example-pipeopdropna"></a>
</h4>
<p>Dropping rows with missing values may be important when training a
model that can not handle them.</p>
<p>Because <a href="https://github.com/mlr-org/mlr3" class="external-link"><code>mlr3</code></a>
<code>Tasks</code> only contain a view to the underlying data, it is not
necessary to modify data to remove rows with missing values. Instead,
the rows can be removed using the <code>Task</code>’s
<code>$filter</code> method, which modifies the <code>Task</code>
in-place. This is done in the private method <code>.train_task()</code>.
We take care that we also set the <code>$state</code> slot to signal
that the <code>PipeOp</code> was trained.</p>
<p>The private method <code>.predict_task()</code> does not need to do
anything; removing missing values during prediction is not as useful,
since learners that cannot handle them will just ignore the respective
rows. Furthermore, <a href="https://github.com/mlr-org/mlr3" class="external-link"><code>mlr3</code></a> expects a
<code>Learner</code> to always return just as many predictions as it was
given input rows, so a <code>PipeOp</code> that removes
<code>Task</code> rows during training can not be used inside a
<code>GraphLearner</code>.</p>
<p>When we inherit from <code>PipeOpTaskPreproc</code>, it sets the
<code>input</code> and <code>output</code> <code>data.table</code>s for
us to only accept a single <code>Task</code>. The only thing we do
during <code>initialize()</code> is therefore to set an <code>id</code>
(which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as
follows. Note that it inherits from <code>PipeOpTaskPreproc</code>,
unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpDropNA</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpDropNA"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOpTaskPreproc.html">PipeOpTaskPreproc</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"drop.na"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .train_task <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">featuredata</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span></span>
<span>      <span class="va">exclude</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">featuredata</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">any</span><span class="op">)</span></span>
<span>      <span class="va">task</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">row_ids</span><span class="op">[</span><span class="op">!</span><span class="va">exclude</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .predict_task <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># nothing to be done</span></span>
<span>      <span class="va">task</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To test this <code>PipeOp</code>, we create a small task with missing
values:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smalliris</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">30</span>, <span class="op">]</span></span>
<span><span class="va">smalliris</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">smalliris</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">sitask</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_classif.html" class="external-link">as_task_classif</a></span><span class="op">(</span><span class="va">smalliris</span>, target <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sitask</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##        &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">## 1:     setosa          1.6         0.2           NA         3.2</span></span>
<span><span class="co">## 2: versicolor          3.9         1.4          5.2          NA</span></span>
<span><span class="co">## 3: versicolor          4.0         1.3          5.5         2.5</span></span>
<span><span class="co">## 4:  virginica          5.0         1.5          6.0         2.2</span></span>
<span><span class="co">## 5:  virginica          5.1         1.8          5.9         3.0</span></span></code></pre>
<p>We test this by feeding it to a new <code>Graph</code> that uses
<code>PipeOpDropNA</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpDropNA</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered_task</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">sitask</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">filtered_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##        &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">## 1: versicolor          4.0         1.3          5.5         2.5</span></span>
<span><span class="co">## 2:  virginica          5.0         1.5          6.0         2.2</span></span>
<span><span class="co">## 3:  virginica          5.1         1.8          5.9         3.0</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="example-pipeopscalealways">Example: <code>PipeOpScaleAlways</code><a class="anchor" aria-label="anchor" href="#example-pipeopscalealways"></a>
</h4>
<p>An often-applied preprocessing step is to simply
<strong>center</strong> and/or <strong>scale</strong> the data to mean
<span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>. This fits the
<code>PipeOpTaskPreproc</code> pattern quite well. Because it always
replaces all columns that it operates on, and does not require any
information about the task’s target, it only needs to overload the
<code>.train_dt()</code> and <code>.predict_dt()</code> functions. This
saves some boilerplate-code from getting the correct feature columns out
of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to
instruct <code>PipeOpTaskPreproc</code> to give us only these numeric
columns. We do this by overloading the <code>.select_cols()</code>
function: It is called by the class to determine which columns to pass
to <code>.train_dt()</code> and <code>.predict_dt()</code>. Its input is
the <code>Task</code> that is being transformed, and it should return a
<code>character</code> vector of all features to work with. When it is
not overloaded, it uses all columns; instead, we will set it to only
give us numeric columns. Because the <code><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels()</a></code> of the data
table given to <code>.train_dt()</code> and <code>.predict_dt()</code>
may be different from the <code>Task</code>’s levels, these functions
must also take a <code>levels</code> argument that is a named list of
column names indicating their levels. When working with numeric data,
this argument can be ignored, but it should be used instead of
<code>levels(dt[[column]])</code> for factorial or character
columns.</p>
<p>This is the first <code>PipeOp</code> where we will be using the
<code>$state</code> slot for something useful: We save the centering
offset and scaling coefficient and use it in
<code>$.predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always
scale and center all data. Compare this <code>PipeOpScaleAlways</code>
operator to the one defined inside the <code>mlr3pipelines</code>
package, <code>PipeOpScale</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpScaleAlways</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpScaleAlways"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOpTaskPreproc.html">PipeOpTaskPreproc</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"scale.always"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .select_cols <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">task</span><span class="op">$</span><span class="va">feature_types</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"numeric"</span>, <span class="va">id</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .train_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"scaled:center"</span><span class="op">)</span>,</span>
<span>        scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"scaled:scale"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">sc</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .predict_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">-</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">center</span><span class="op">)</span> <span class="op">/</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code>
from the <code>mlr3pipelines</code> package, you will notice that is
uses “<code>get("type")</code>” and “<code>get("id")</code>” instead of
“<code>type</code>” and “<code>id</code>”, because the static code
checker on CRAN would otherwise complain about references to undefined
variables. This is a “problem” with <code>data.table</code> and not
exclusive to <code>mlr3pipelines</code>.)</em></p>
<p>We can, again, create a new <code>Graph</code> that uses this
<code>PipeOp</code> to test it. Compare the resulting data to the
original “iris” <code>Task</code> data printed at the beginning:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlways</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></span>
<span><span class="co">##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></span>
<span><span class="co">##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></span>
<span><span class="co">##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></span>
<span><span class="co">##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></span>
<span><span class="co">##  ---                                                            </span></span>
<span><span class="co">## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></span>
<span><span class="co">## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></span>
<span><span class="co">## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></span>
<span><span class="co">## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></span>
<span><span class="co">## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="special-case-preprocessing-with-simple-train">Special Case: Preprocessing with Simple Train<a class="anchor" aria-label="anchor" href="#special-case-preprocessing-with-simple-train"></a>
</h3>
<p>It is possible to make even further simplifications for many
<code>PipeOp</code>s that perform mostly the same operation during
training and prediction. The point of <code>Task</code> preprocessing is
often to modify the training data in mostly the same way as prediction
data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove
features that have no variance, or only a single factor level. However,
what features get removed must be decided during <em>training</em>, and
may only depend on training data. Furthermore, the actual process of
removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a private method
<code>.get_state(task)</code> which sets the <code>$state</code> slot
during training, and a private method <code>.transform(task)</code>,
which gets called both during training <em>and</em> prediction. This is
done in the <code>PipeOpTaskPreprocSimple</code> class. Just like
<code>PipeOpTaskPreproc</code>, one can inherit from this and overload
these functions to get a <code>PipeOp</code> that performs preprocessing
with very little boilerplate code.</p>
<p>Just like <code>PipeOpTaskPreproc</code>,
<code>PipeOpTaskPreprocSimple</code> offers the possibility to instead
overload the <code>.get_state_dt(dt, levels)</code> and
<code>.transform_dt(dt, levels)</code> methods (and optionally, again,
the <code>.select_cols(task)</code> function) to operate on
<code>data.table</code> feature data instead of the whole
<code>Task</code>.</p>
<p>Even some methods that do not use
<code>PipeOpTaskPreprocSimple</code> <em>could</em> work in a similar
way: The <code>PipeOpScaleAlways</code> example from above will be shown
to also work with this paradigm.</p>
<div class="section level4">
<h4 id="example-pipeopdropconst">Example: <code>PipeOpDropConst</code><a class="anchor" aria-label="anchor" href="#example-pipeopdropconst"></a>
</h4>
<p>A typical example of a preprocessing operation that does almost the
same operation during training and prediction is an operation that drops
features depending on a criterion that is evaluated during training. One
simple example of this is dropping constant features. Because the <a href="https://github.com/mlr-org/mlr3" class="external-link"><code>mlr3</code></a>
<code>Task</code> class offers a flexible view on underlying data, it is
most efficient to drop columns from the task directly using its
<code>$select()</code> function, so the
<code>.get_state_dt(dt, levels)</code> /
<code>.transform_dt(dt, levels)</code> functions will <em>not</em> get
used; instead we overload the <code>.get_state(task)</code> and
<code>.transform(task)</code> methods.</p>
<p>The <code>.get_state()</code> function’s result is saved to the
<code>$state</code> slot, so we want to return something that is useful
for dropping features. We choose to save the names of all the columns
that have nonzero variance. For brevity, we use
<code>length(unique(column)) &gt; 1</code> to check whether more than
one distinct value is present; a more sophisticated version could have a
tolerance parameter for numeric values that are very close to each
other.</p>
<p>The <code>.transform()</code> method is evaluated both during
training <em>and</em> prediction, and can rely on the
<code>$state</code> slot being present. All it does here is call the
<code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <code>PipeOp</code> could be written as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpDropConst</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpDropConst"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOpTaskPreprocSimple.html">PipeOpTaskPreprocSimple</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"drop.const"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .get_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span></span>
<span>      <span class="va">nonconst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="kw">function</span><span class="op">(</span><span class="va">column</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">column</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="va">nonconst</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .transform <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">cnames</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This can be tested using the first five rows of the “Iris”
<code>Task</code>, for which one feature (<code>"Petal.Width"</code>) is
constant:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irishead</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">irishead</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##     &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">## 1:  setosa          1.4         0.2          5.1         3.5</span></span>
<span><span class="co">## 2:  setosa          1.4         0.2          4.9         3.0</span></span>
<span><span class="co">## 3:  setosa          1.3         0.2          4.7         3.2</span></span>
<span><span class="co">## 4:  setosa          1.5         0.2          4.6         3.1</span></span>
<span><span class="co">## 5:  setosa          1.4         0.2          5.0         3.6</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpDropConst</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dropped_task</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">irishead</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">dropped_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Species Petal.Length Sepal.Length Sepal.Width</span></span>
<span><span class="co">##     &lt;fctr&gt;        &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">## 1:  setosa          1.4          5.1         3.5</span></span>
<span><span class="co">## 2:  setosa          1.4          4.9         3.0</span></span>
<span><span class="co">## 3:  setosa          1.3          4.7         3.2</span></span>
<span><span class="co">## 4:  setosa          1.5          4.6         3.1</span></span>
<span><span class="co">## 5:  setosa          1.4          5.0         3.6</span></span></code></pre>
<p>We can also see that the <code>$state</code> was correctly set.
Calling <code>$.predict()</code> with this graph, even with different
data (the whole Iris <code>Task</code>!) will still drop the
<code>"Petal.Width"</code> column, as it should.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">drop.const</span><span class="op">$</span><span class="va">state</span></span></code></pre></div>
<pre><code><span><span class="co">## $cnames</span></span>
<span><span class="co">## [1] "Petal.Length" "Sepal.Length" "Sepal.Width" </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $affected_cols</span></span>
<span><span class="co">## [1] "Petal.Length" "Petal.Width"  "Sepal.Length" "Sepal.Width" </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $intasklayout</span></span>
<span><span class="co">## Key: &lt;id&gt;</span></span>
<span><span class="co">##              id    type</span></span>
<span><span class="co">##          &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">## 1: Petal.Length numeric</span></span>
<span><span class="co">## 2:  Petal.Width numeric</span></span>
<span><span class="co">## 3: Sepal.Length numeric</span></span>
<span><span class="co">## 4:  Sepal.Width numeric</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $outtasklayout</span></span>
<span><span class="co">## Key: &lt;id&gt;</span></span>
<span><span class="co">##              id    type</span></span>
<span><span class="co">##          &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">## 1: Petal.Length numeric</span></span>
<span><span class="co">## 2: Sepal.Length numeric</span></span>
<span><span class="co">## 3:  Sepal.Width numeric</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $outtaskshell</span></span>
<span><span class="co">## Empty data.table (0 rows and 4 cols): Species,Petal.Length,Sepal.Length,Sepal.Width</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dropped_predict</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">dropped_predict</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa          1.4          5.1         3.5</span></span>
<span><span class="co">##   2:    setosa          1.4          4.9         3.0</span></span>
<span><span class="co">##   3:    setosa          1.3          4.7         3.2</span></span>
<span><span class="co">##   4:    setosa          1.5          4.6         3.1</span></span>
<span><span class="co">##   5:    setosa          1.4          5.0         3.6</span></span>
<span><span class="co">##  ---                                                </span></span>
<span><span class="co">## 146: virginica          5.2          6.7         3.0</span></span>
<span><span class="co">## 147: virginica          5.0          6.3         2.5</span></span>
<span><span class="co">## 148: virginica          5.2          6.5         3.0</span></span>
<span><span class="co">## 149: virginica          5.4          6.2         3.4</span></span>
<span><span class="co">## 150: virginica          5.1          5.9         3.0</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="example-pipeopscalealwayssimple">Example: <code>PipeOpScaleAlwaysSimple</code><a class="anchor" aria-label="anchor" href="#example-pipeopscalealwayssimple"></a>
</h4>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can
be used when only working on feature data in form of a
<code>data.table</code>. Instead of calling the <code><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale()</a></code>
function, the <code>center</code> and <code>scale</code> values are
calculated directly and saved to the <code>$state</code> slot. The
<code>.transform_dt()</code> function will then perform the same
operation during both training and prediction: subtract the
<code>center</code> and divide by the <code>scale</code> value. As in
the <a href="#example-pipeopscalealways"><code>PipeOpScaleAlways</code>
example above</a>, we use <code>.select_cols()</code> so that we only
work on numeric columns.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpScaleAlwaysSimple</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpScaleAlwaysSimple"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="../reference/PipeOpTaskPreprocSimple.html">PipeOpTaskPreprocSimple</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"scale.always.simple"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .select_cols <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">task</span><span class="op">$</span><span class="va">feature_types</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"numeric"</span>, <span class="va">id</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .get_state_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>        scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    .transform_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">-</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">center</span><span class="op">)</span> <span class="op">/</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can compare this <code>PipeOp</code> to the one above to show that
it behaves the same.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlways</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result_posa</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlwaysSimple</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result_posa_simple</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_posa</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></span>
<span><span class="co">##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></span>
<span><span class="co">##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></span>
<span><span class="co">##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></span>
<span><span class="co">##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></span>
<span><span class="co">##  ---                                                            </span></span>
<span><span class="co">## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></span>
<span><span class="co">## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></span>
<span><span class="co">## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></span>
<span><span class="co">## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></span>
<span><span class="co">## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_posa_simple</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199</span></span>
<span><span class="co">##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881</span></span>
<span><span class="co">##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751</span></span>
<span><span class="co">##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935</span></span>
<span><span class="co">##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015</span></span>
<span><span class="co">##  ---                                                            </span></span>
<span><span class="co">## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881</span></span>
<span><span class="co">## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961</span></span>
<span><span class="co">## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881</span></span>
<span><span class="co">## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383</span></span>
<span><span class="co">## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="ext-pipe-hyperpars">Hyperparameters<a class="anchor" aria-label="anchor" href="#ext-pipe-hyperpars"></a>
</h3>
<p><code>mlr3pipelines</code> uses the <a href="https://paradox.mlr-org.com" class="external-link"><code>paradox</code></a> package to
define parameter spaces for <code>PipeOp</code>s. Parameters for
<code>PipeOp</code>s can modify their behavior in certain ways,
e.g. switch centering or scaling off in the <code>PipeOpScale</code>
operator. The unified interface makes it possible to have parameters for
whole <code>Graph</code>s that modify the individual
<code>PipeOp</code>’s behavior. The <code>Graph</code>s, when
encapsulated in <code>GraphLearner</code>s, can even be tuned using the
tuning functionality in <a href="https://mlr3tuning.mlr-org.com" class="external-link"><code>mlr3tuning</code></a>.</p>
<p>Hyperparameters are declared during initialization, when calling the
<code>PipeOp</code>’s <code>$initialize()</code> function, by giving a
<code>param_set</code> argument. The <code>param_set</code> must be a
<code>ParamSet</code> from the <a href="https://paradox.mlr-org.com" class="external-link"><code>paradox</code></a> package; see
its documentation for more information on how to define parameter
spaces. After construction, the <code>ParamSet</code> can be accessed
through the <code>$param_set</code> slot. While it is <em>possible</em>
to modify this <code>ParamSet</code>, using e.g. the <code>$add()</code>
and <code>$add_dep()</code> functions, <em>after</em> adding it to the
<code>PipeOp</code>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the
<code>$values</code> slot. When setting hyperparameters, they are
automatically checked to satisfy all conditions set by the
<code>$param_set</code>, so it is not necessary to type check them. Be
aware that it is always possible to <em>remove</em> hyperparameter
values.</p>
<p>When a <code>PipeOp</code> is initialized, it usually does not have
any parameter values—<code>$values</code> takes the value
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>. It is possible to set initial parameter values in
the <code>$initialize()</code> constructor; this must be done
<em>after</em> the <code>super$initialize()</code> call where the
corresponding <code>ParamSet</code> must be supplied. This is because
setting <code>$values</code> checks against the current
<code>$param_set</code>, which would fail if the <code>$param_set</code>
was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code>
function in <code>PipeOpScale</code>, say), then there is usually a
“default” behaviour of that function when a parameter is not given. It
is good practice to use this default behaviour whenever a parameter is
not set (or when it was removed). This can easily be done when using the
<a href="https://mlr3misc.mlr-org.com" class="external-link"><code>mlr3misc</code></a>
library’s <code><a href="https://mlr3misc.mlr-org.com/reference/invoke.html" class="external-link">mlr3misc::invoke()</a></code> function, which has
functionality similar to <code>"do.call()"</code>.</p>
<div class="section level4">
<h4 id="hyperparameter-example-pipeopscale">Hyperparameter Example: <code>PipeOpScale</code><a class="anchor" aria-label="anchor" href="#hyperparameter-example-pipeopscale"></a>
</h4>
<p>How to use hyperparameters can best be shown through the example of
<code>PipeOpScale</code>, which is very similar to the example above,
<code>PipeOpScaleAlways</code>. The difference is made by the presence
of hyperparameters. <code>PipeOpScale</code> constructs a
<code>ParamSet</code> in its <code>$initialize</code> function and
passes this on to the <code>super$initialize</code> function:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpScale</span><span class="op">$</span><span class="va">public_methods</span><span class="op">$</span><span class="va">initialize</span></span></code></pre></div>
<pre><code><span><span class="co">## function (id = "scale", param_vals = list()) </span></span>
<span><span class="co">## .__PipeOpScale__initialize(self = self, private = private, super = super, </span></span>
<span><span class="co">##     id = id, param_vals = param_vals)</span></span>
<span><span class="co">## &lt;environment: namespace:mlr3pipelines&gt;</span></span></code></pre>
<p>The user has access to this and can set and get parameters. Types are
automatically checked:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pss</span> <span class="op">=</span> <span class="fu"><a href="../reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;ParamSet(4)&gt;</span></span>
<span><span class="co">##                id    class lower upper nlevels        default  value</span></span>
<span><span class="co">##            &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;         &lt;list&gt; &lt;list&gt;</span></span>
<span><span class="co">## 1:         center ParamLgl    NA    NA       2           TRUE [NULL]</span></span>
<span><span class="co">## 2:          scale ParamLgl    NA    NA       2           TRUE [NULL]</span></span>
<span><span class="co">## 3:         robust ParamLgl    NA    NA       2 &lt;NoDefault[0]&gt;  FALSE</span></span>
<span><span class="co">## 4: affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt; [NULL]</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">center</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $center</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $robust</span></span>
<span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">scale</span> <span class="op">=</span> <span class="st">"TRUE"</span> <span class="co"># bad input is checked!</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in self$assert(xs, sanitize = TRUE): Assertion on 'xs' failed: scale: Must be of type 'logical flag', not 'character'.</span></span></code></pre>
<p>How <code>PipeOpScale</code> handles its parameters can be seen in
its <code>$.train_dt</code> method: It gets the relevant parameters from
its <code>$values</code> slot and uses them in the
<code><a href="https://mlr3misc.mlr-org.com/reference/invoke.html" class="external-link">mlr3misc::invoke()</a></code> call. This has the advantage over
calling <code><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale()</a></code> directly that if a parameter is not given,
its default value from the <code>"scale()"</code> function will be
used.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PipeOpScale</span><span class="op">$</span><span class="va">private_methods</span><span class="op">$</span><span class="va">.train_dt</span></span></code></pre></div>
<pre><code><span><span class="co">## function (dt, levels, target) </span></span>
<span><span class="co">## .__PipeOpScale__.train_dt(self = self, private = private, super = super, </span></span>
<span><span class="co">##     dt = dt, levels = levels, target = target)</span></span>
<span><span class="co">## &lt;environment: namespace:mlr3pipelines&gt;</span></span></code></pre>
<p>Another change that is necessary compared to
<code>PipeOpScaleAlways</code> is that the attributes
<code>"scaled:scale"</code> and <code>"scaled:center"</code> are not
always present, depending on parameters, and possibly need to be set to
default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call
<code>PipeOpScale</code> with both <code>scale</code> and
<code>center</code> set to <code>FALSE</code>, which returns the
original dataset, unchanged.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">center</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="../reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">pss</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width</span></span>
<span><span class="co">##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">##   1:    setosa          1.4         0.2          5.1         3.5</span></span>
<span><span class="co">##   2:    setosa          1.4         0.2          4.9         3.0</span></span>
<span><span class="co">##   3:    setosa          1.3         0.2          4.7         3.2</span></span>
<span><span class="co">##   4:    setosa          1.5         0.2          4.6         3.1</span></span>
<span><span class="co">##   5:    setosa          1.4         0.2          5.0         3.6</span></span>
<span><span class="co">##  ---                                                            </span></span>
<span><span class="co">## 146: virginica          5.2         2.3          6.7         3.0</span></span>
<span><span class="co">## 147: virginica          5.0         1.9          6.3         2.5</span></span>
<span><span class="co">## 148: virginica          5.2         2.0          6.5         3.0</span></span>
<span><span class="co">## 149: virginica          5.4         2.3          6.2         3.4</span></span>
<span><span class="co">## 150: virginica          5.1         1.8          5.9         3.0</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Binder, Florian Pfisterer, Lennart Schneider, Bernd Bischl, Michel Lang, Sebastian Fischer, Susanne Dandl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
